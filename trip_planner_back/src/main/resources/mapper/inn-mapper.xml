<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="kr.or.iei.inn.model.dao.InnDao">
	<select id="selectRoomOption" resultType="option">
		select * from option_tbl
	</select>
	
	<insert id="insertInn">
		insert into inn_tbl values
			(inn_seq.nextval,
			#{partnerNo},
			#{innType},
			#{innAddr},
			#{innInfo},
			#{innCheckInTime},
			#{innCheckOutTime},
			#{innIntro})
			<selectKey resultType="int" keyProperty="innNo" order="AFTER">
				select max(inn_no) from inn_tbl
			</selectKey>
	</insert>

	<insert id="insertInnFile">
		insert into inn_file_tbl values(inn_file_seq.nextval,#{innNo},null,#{innFilePath})
	</insert>
	
	<select id="getInnNo" resultType="int">
		select inn_no from inn_tbl where partner_no=#{partnerNo}
	</select>
	
	<insert id="insertRoom">
		insert into room_tbl values
		(room_seq.nextval,
		#{innNo},
		#{roomName},
		#{roomMaxPeople},
		#{roomPrice},
		#{etcOption},
		#{roomMinPeople})
		<selectKey resultType="int" keyProperty="roomNo" order="AFTER">
			select max(room_no) from room_tbl
		</selectKey>
	</insert>
	
	<insert id="insertRoomFile">
		insert into inn_file_tbl values(inn_file_seq.nextval,#{innNo},#{roomNo},#{innFilePath})
	</insert>
	
	<insert id="insertRoomOption">
		insert into room_option_tbl values(#{roomNo},#{optionNo})
	</insert>
	
	<insert id="insertRoomHashTag">
		insert into room_hashtag_tbl values(#{roomNo},#{hashTag})
	</insert>
	
	<select id="selectInnDetail" resultType="inn">
		select * from inn_tbl where inn_no=#{innNo}
		
	</select>
	
	<insert id="reservationInn">
		insert into inn_book_tbl values
		(inn_book_seq.nextval, 
		#{memberNo}, 
		#{roomNo},
		#{guestName},
		#{guestPhone},
		#{guestWish},
		#{checkInDate},
		#{checkOutDate},
		sysdate,
		1,
		#{bookGuest})
	</insert>
	
	<select id="selectBookInnsList" resultType="innReservation">
		select * from (select rownum rnum, ibt.* from
			(select inn_book_no,
			    (select partner_name from partner_tbl where partner_no in
			        (select partner_no from inn_tbl where inn_no in
			            (select inn_no from room_tbl where room_no = ib.room_no))) partner_name,
			            (select inn_filepath from inn_file_tbl where room_no = ib.room_no and rownum = 1) inn_filepath,
			            (select room_name from room_tbl where room_no = ib.room_no) room_name, book_status,
			            to_char(to_date(check_in_date), 'mm.dd(dy) ')||(select inn_check_in_time from inn_tbl where inn_no in(select inn_no from room_tbl where room_no=ib.room_no)) check_in_date,
			            to_char(to_date(check_out_date), 'mm.dd(dy) ')||(select inn_check_out_time from inn_tbl where inn_no in(select inn_no from room_tbl where room_no=ib.room_no)) check_out_date,
			            (to_date(check_out_date)-to_date(check_in_date)) night,
			            book_guest, guest_name, guest_phone, to_char(book_date, 'yyyy-mm-dd') book_date, guest_wish
			        from inn_book_tbl ib
			    where member_no in
			(select member_no from member_tbl where member_email=#{memberEmail}) order by check_in_date, inn_book_no desc)ibt) where rnum between #{start} and #{end}
	</select>
</mapper>
